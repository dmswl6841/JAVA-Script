<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>fileUpload</title>
<style>
form {
	border: 2px solid green;
}

form>label {
	display: inline-block;
	width: 25%;
	background-color: yellow;
}

#memberName {
	background-color: aqua;
}

input[name='phone'] {
	background-color: aqua;
}
</style>
</head>
<body>
	<form action="MemberUpload" name="memberForm" method="post" enctype="multipart/form-data">
		<label for="memberId">회원번호</label>
		<input type="number" name="memberId" id="memberId"><br>
		
		<label for="memberName">회원이름</label>
		<input type="text" name="memberName" id="memberName"><br>
		
		<label for="memberPhone">연락처</label>
		<input type="text" name="phone" id="phone"><br> 
		
		<label for="memberAddr">주소</label>
		<input type="text" name="addr" id="addr"><br>
		
		<label for="memberbirth">생년월일</label>
		<input type="date" name="birth" id="birth"><br>
		
		<label for="memberImage">사진</label>
		<input type="file" name="image" id="image"><br>
		
		<input type="submit" value="추가">
		<input type="reset" value="초기화">
		<input type="button" value="선택삭제" id="deleteSel">
		<input type="button" value="수정" id="modify">
	</form>
	<div id="show">
		<table border="1">
			<thead>
				<tr>
					<td>회원번호</td>
					<td>회원이름</td>
					<td>연락처</td>
					<td>주소</td>
					<td>생년월일</td>
					<td>사진</td>
					<td>삭제</td>
					<td>선택</td>
				</tr>
			</thead>
			<tbody id="memberList">
			</tbody>
		</table>
	</div>

	<script>

	let fields = ['memNo','memName','memPhone','memAddr','memBirth','memImage'];
	
	let xhtp = new XMLHttpRequest();
	xhtp.open('get','member?cmd=list');
	xhtp.send();
	xhtp.onload = showList;
	
	function showList() {
		let data = JSON.parse(this.responseText);
		let tbody = document.querySelector('#show tbody');
		console.log(data);
		data.forEach(emp => {
			tbody.append(mkTr(emp));
		});
	}
	/*
	//추가
	document.forms.memberForm.addEventListener('submit',function(e){
		//e.preventDefault();
		console.log(this);
		let mNo = this.memberId.value;
		let mName = this.memberName.value;
		let mPhone = this.phone.value;
		let mAddr = this.addr.value;
		let mBirth = this.birth.value;

		xhtp.open('post','member');	// 요청방식: post  매개값이 몸체에 담겨 넘어감
		xhtp.setRequestHeader('Content-type','application/x-www-form-urlencoded');
		xhtp.send(`name=${mName}&address=${mAddr}&phone=${mPhone}&birth=${mBirth}&cmd=add`);
		xhtp.onload = function(){
			console.log(this.responseText);
			let result = JSON.parse(this.responseText);
			console.log(result);
			document.querySelector('#show tbody').append(mkTr(result));
		}
	})
	*/
	
	
		//회원정보 => tr 생성
		function mkTr(member){
			let tr = document.createElement('tr');
			tr.setAttribute('id',member.memNo);	//tr의 attribute 활용
			fields.forEach(field=>{
				let td = document.createElement('td');
				//null, 0, undefined, '' => false. 이외 true
				td.innerHTML = member[field]?(field=='memImage' ? '<img width="60px" src="images/'+ member[field] +'">' : member[field]):'';
				//1. td.innerHTML = member[field]?member[field] : <<<(!''?field == 'memImage'?'no imag': '':'')>>>;
				//2. !''? <<<field == 'memImage'?'no imag': ''>>> :''
				//3. field == 'memImage'?'no imag': ''
				tr.append(td);
			})
			//삭제 버튼
			let btn = document.createElement('button');
			btn.innerHTML = '삭제';
			btn.addEventListener('click',rowDelete, false);
			//bubbling, capture
			let td = document.createElement('td');
			td.append(btn);
			tr.append(td);
			
			//체크박스. input타입이 체크박스
			let checkbox = document.createElement('input');
			checkbox.setAttribute('type','checkbox');
			td = document.createElement('td');
			td.append(checkbox);
			tr.append(td);
			
			
			return tr;
		}
		//삭제 실행(콜백함수)
		function rowDelete(){
			console.log(this.parentElement.parentElement.children[0].innerHTML)
			//this : 버튼 태그 //this.parentElement : 버튼의 상위 태그 = td 태그	//this.parentElement.parentElement : td태그(버튼의 상위 태그)의 상위태그 = tr태그
			let delId = this.parentElement.parentElement.children[0].innerHTML;
			let delAjax = new XMLHttpRequest();
			delAjax.open('post','member');
			delAjax.setRequestHeader('Content-type','application/x-www-form-urlencoded');
			delAjax.send(`cmd=remove&deleteno=${delId}`);
			delAjax.onload = function(){
				let result  = JSON.parse(delAjax.responseText);
				// 결과 값이 Success
				if (result.retCode =='Success'){
					document.getElementById(delId).remove();
				}else { // 결과 값이 Fail
					alert('처리 중 에러가 발생했습니다.')
				}
			}
		}
		

	</script>

</body>
</html>